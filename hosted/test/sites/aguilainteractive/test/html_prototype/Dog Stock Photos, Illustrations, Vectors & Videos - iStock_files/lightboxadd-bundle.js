
namespacing={init:function(namespace){var spaces=[];namespace.split('.').each(function(space){var curSpace=window,i;spaces.push(space);for(i=0;i<spaces.length;i++){if(typeof curSpace[spaces[i]]==='undefined'){curSpace[spaces[i]]={};}
curSpace=curSpace[spaces[i]];}});}};Event.observe(document,'dom:loaded',function(){namespacing.init('istock.Modal');istock.Modal=Class.create({initialize:function(options){this._options={bgId:'ajaxWinBG',modalClass:'modalDialog',bgEvents:{}};Object.deepExtend(this._options,options||{});this._body=$$('body')[0];this._bg=new Element('div',{id:this._options.bgId});this._modal=new Element('div',{'class':this._options.modalClass});},show:function(){this._body.insert({top:this._bg});this._body.insert({top:this._modal});this._bg.setStyle({display:'none'});this._modal.setStyle({display:'none'});this._showBg();},hide:function(){this._hideModal();},_hideBg:function(){var events=this._options.bgEvents,key;this._bg.stopObserving();this._bg.fade({duration:0.2,afterFinish:function(){this._bg.remove();this._body.setStyle({overflow:'auto'});}.bind(this)});},_hideModal:function(){this._modal.fade({duration:0.2,afterFinish:function(){this._hideBg();this._modal.remove();}.bind(this)});},_showBg:function(){var style={},scrollOffsets=document.viewport.getScrollOffsets(),viewportDims=document.viewport.getDimensions(),events=this._options.bgEvents,key;style.width=(viewportDims.width*3)+scrollOffsets.left+'px';style.height=(viewportDims.height*3)+scrollOffsets.top+'px';style.left=scrollOffsets.left+'px';style.top=scrollOffsets.top+'px';this._bg.setStyle(style);this._body.setStyle({overflow:'hidden'});for(key in events){if(events.hasOwnProperty(key)&&events[key]){this._bg.observe(key,events[key].bind(this));}}
this._bg.appear({duration:0.3,from:0,to:0.5,afterFinish:this._showModal.bind(this)});},_showModal:function(){this._reposition();this._modal.setStyle({display:'none'});this._modal.appear({duration:0.3});},_reposition:function(){var pos;this._modal.show();pos=this._getCenter();this._modal.setStyle({left:pos.left+'px',top:pos.top+'px'});},_getCenter:function(){var vp=document.viewport.getDimensions(),scroll=document.viewport.getScrollOffsets(),modal={width:this._modal.getLayout().get('margin-box-width'),height:this._modal.getLayout().get('margin-box-height')},center={};center.left=Math.floor(((vp.width/2)+scroll.left)-(modal.width/2));center.top=Math.floor(((vp.height/2)+scroll.top)-(modal.height/2));return center;}});namespacing.init('istock.templates.lightbox');istock.templates.lightbox.dialog=new Template('<div id="#{containerId}">'+'<div class="lbTitle">'+'<span>#{title}</span>'+'<div class="lbCloseButton"><img src="'+istock.cookielessUrl+'/static/images/blank.gif" class="modalClose" /></div>'+'</div>'+'<div class="lbContent">'+'#{content}'+'</div>'+'</div>');namespacing.init('istock.search.templates.lightbox');istock.search.templates.lightbox.email=new Template('<label for="lbEmailAddress">#{emailAddress}</label>'+'<input id="lbEmailAddress" value="" type="text" />'+'<label for="lbMessage">#{emailMessage}</label>'+'<textarea id="lbMessage"></textarea>'+'<input id="lbSendEmail" value="#{buttons.send}" type="submit" class="btnCta1" />');namespacing.init('istock.search.templates.lightbox');istock.search.templates.lightbox.add=new Template('<div><select id="lbAddSelect"><option value="-1">#{selectLightbox}</option>#{lbAddOptions}</select></div>'+'<div>'+'<a href="#" class="e_custom click istock.search.lightbox.AddFiles toggleCreate cp">#{createLightbox}</a>'+'<img src="'+istock.cookielessUrl+'/static/images/blank.gif" class="e_custom click istock.search.lightbox.AddFiles toggleCreate cp ctaGreyArrowDown" />'+'</div>'+'<div id="lbCreate" style="display:none">'+'<div>'+'<label for="lbAddName">#{form.name}</label>'+'<input type="text" id="lbAddName" />'+'<label for="lbAddName">#{form.description}</label>'+'<textarea id="lbAddDescription"></textarea>'+'<label for="lbAddName">#{form.keywords}</label>'+'<textarea id="lbAddKeywords"></textarea>'+'</div>'+'</div>'+'<input type="submit" class="btnCta1" id="lbAdd" value="#{buttons.add}" />');namespacing.init('istock.search.templates.lightbox');istock.search.templates.lightbox.addByFileId=new Template('<label for="lbAddFileId">#{form.enterFileIds}</label>'+'<input type="text" id="lbAddFileId" />'+'<input type="submit" class="btnCta1" id="lbAdd" value="#{buttons.add}" />');namespacing.init('istock.search.templates.lightbox');istock.search.templates.lightbox.addPageDone=new Template('<span>#{pageAdded}</span>'+'#{addAnother}');namespacing.init('istock.search.templates.lightbox');istock.search.templates.lightbox.actionFailed=new Template('<div">'+'<span>#{failure.message}</span>'+'</div>'+'<input type="submit" class="btnCta1" id="lbTryAgain" value="#{buttons.tryAgain}" />');namespacing.init('istock.search.templates.lightbox');istock.search.templates.lightbox.tools=new Template('<div id="lightboxTools">'+'<span id="lightboxToolsLabel">#{label.lightbox} </span>'+'<ul class="separatedList dil">'+'<li class="lbPage" style="display:none;"><a href="#{url.buy}">#{label.buy}</a></li>'+'<li class="lbAdmin" style="display:none;"><a href="#" class="e_lightboxAddFile">#{label.addFile}</a></li>'+'<li id="lbAddPage"><a href="#" class="e_lightboxAddPage">#{label.addPage}</a></li>'+'<li class="lbOwner" style="display:none;"><a href="#" class="e_lightboxEmail">#{label.email}</a></li>'+'<li class="lbOwner" style="display:none;"><a href="#{url.edit}">#{label.edit}</a></li>'+'</ul>'+'</div>');namespacing.init('istock.search.lightbox');istock.search.lightbox.Dialog=Class.create(istock.Modal,{observe:function(e){var classes=$w(e.element().className),modalOptions={bgEvents:{click:function(){this.hide();}}};if(classes[0]&&classes[0].startsWith('e_')){switch(classes[0]){case'e_lightboxAddPage':if(e.type!=='click'){return;}
e.stop();(function(dialog){var lbAddPage=new istock.search.lightbox.AddFiles(modalOptions);lbAddPage._lightbox=dialog._lightbox;lbAddPage.show('addPage');})(this);break;case'e_lightboxAddFile':if(e.type!=='click'){return;}
e.stop();(function(dialog){var lbAddFile=new istock.search.lightbox.AddFiles(modalOptions);lbAddFile.clearFileIds();lbAddFile.addFileId(classes[1]);lbAddFile._lightbox=dialog._lightbox;lbAddFile.show('addFiles');})(this);break;case'e_lightboxEmail':if(e.type!=='click'){return;}
e.stop();(function(dialog){var lbEmail=new istock.search.lightbox.Email(modalOptions);lbEmail._lightbox=dialog._lightbox;lbEmail.show();})(this);break;case'e_lightboxRemoveFile':if(e.type!=='click'){return;}
e.stop();this._removeFile(classes[1]);break;default:break;}}},_removeFile:function(fileId){var lightbox=Object.toJSON({lightboxId:this._lightbox.id,addAction:false,abstractFileIds:[parseInt(fileId,10)]}),ajx;if(!this._lightbox.id){return;}
ajx=new Ajax.Request('/my-account/lightbox/updatefiles',{method:'post',parameters:{options:lightbox},onSuccess:function(r){var json=r.responseText.evalJSON(true);if($('srItem_'+fileId)){$('srItem_'+fileId).dropOut({afterFinish:function(){istock.widget.Loupe.hide(fileId);$('srItem_'+fileId).remove();}});}else if($('lsrRow_'+fileId)){$('lsrRow_'+fileId).dropOut({afterFinish:function(){$('lsrRow_'+fileId).remove();}});}
if(json.filesUpdated>0){istock.search.resultsHandler.adjustTotalResultCount(json.filesUpdated*-1);}}.bind(this)});},show:function($super){var modalContainer=$$('.modalDialog')[0];if(!modalContainer||!modalContainer.visible()){$super();this._addCloseObserver();}},_updateModal:function(template,id,title){var content=istock.search.templates.lightbox[template];this._templateData.containerId=id;this._templateData.title=title;this._templateData.content=content.evaluate(this._templateData);this._modal.update(this._dialog.evaluate(this._templateData));this._reposition();this._addCloseObserver();},_addCloseObserver:function(){var modalDialog=$$('#'+this._templateData.containerId+' .modalClose')[0];if(modalDialog){modalDialog.stopObserving();modalDialog.observe('click',function(){this.hide();}.bind(this));}},_dialog:istock.templates.lightbox.dialog,_lightbox:{}});document.observe('lightboxadd:loaded',function(){var lbDialog=new istock.search.lightbox.Dialog();document.observe('click',lbDialog.observe.bind(lbDialog));document.observe(istock.search.event.ADD_FACET,function(event){var t=translations.search.lightbox.tools,data={label:{lightbox:t.label,buy:t.buy,addFile:t.addFile,addPage:t.addPage,email:t.email,edit:t.edit},url:{buy:'/lightbox_download.php?id=',edit:'/my_lightbox_edit.php?ID='}},template=istock.search.templates.lightbox.tools,managedBy,flags=istock.search.lightbox.flags;if(event.memo.facet.type===istock.search.facetTypes.LIGHTBOX){lbDialog._lightbox={id:parseInt(event.memo.facet.value,10),name:event.memo.facet.title};flags.isLightbox=true;data.url.buy+=lbDialog._lightbox.id;data.url.edit+=lbDialog._lightbox.id;if(flags.managedBy){managedBy=new Element('div',{id:'lightboxDesc','class':'footnote'});managedBy.update(t.managedBy+' <a href="/'+flags.managedBy+'">'+flags.managedBy+'</a>. '+flags.description);$('searchTitle').insert({after:managedBy});};if(flags.isOwner||flags.isAdmin){$$('.lbAdd').each(function(lbIcon){lbIcon.className=lbIcon.className.replace('e_lightboxAddFile','e_lightboxRemoveFile');lbIcon.className=lbIcon.className.replace('lbAdd','lbDel');});}}
if(istock.loggedin){if(!$('lightboxTools')){template=template.evaluate(data);$('pgntrFtr').insert({after:template});}
if(lbDialog._lightbox.id){$$('.lbPage').invoke('show');if(istock.search.lightbox.flags.isAdmin){$$('.lbAdmin').invoke('show');}else if(istock.search.lightbox.flags.isOwner){$$('.lbOwner','.lbAdmin').invoke('show');};}else{$('lbAddPage').setStyle({border:'none',padding:0});}};});document.observe(istock.search.event.REMOVE_FACET,function(event){if(event.memo.facet.type===istock.search.facetTypes.LIGHTBOX){lbDialog._lightbox={};$$('#lightboxDesc','.lbAdmin','.lbOwner','.lbPage').invoke('hide');istock.search.lightbox.flags.isLightbox=false;$$('.lbDel').each(function(lbIcon){lbIcon.className=lbIcon.className.replace('e_lightboxRemoveFile','e_lightboxAddFile');lbIcon.className=lbIcon.className.replace('lbDel','lbAdd');});}});});namespacing.init('istock.search.lightbox');istock.search.lightbox.Email=Class.create(istock.search.lightbox.Dialog,{show:function($super,action){this._updateModal('email','lbEmailLightbox',translations.search.lightbox.email.title);$super();$('lbSendEmail').observe('click',function(){if(this._validateFields()){this._sendEmail();}}.bind(this));},hide:function($super){if($('lbSendEmail')){$('lbSendEmail').stopObserving();}
$$('#'+this._templateData.containerId+' .modalClose')[0].stopObserving();$super();},_validateFields:function(){var errMsg='',emailRegExp=/.+@.+\..+/;if($('lbEmailAddress').value===''||!emailRegExp.test($('lbEmailAddress').value)){errMsg=new Element('div',{'class':'err'}).update(translations.search.lightbox.email.validation.emailAddress);$('lbEmailAddress').insert({after:errMsg});setTimeout(function(){errMsg.fade({duration:0.5,afterFinish:function(){errMsg.remove();}});},2000);return false;}
return true;},_sendEmail:function(){var ajx;ajx=new Ajax.Request('/my-account/lightbox/email',{method:'post',parameters:{options:Object.toJSON({recipientEmail:$('lbEmailAddress').value,message:$('lbMessage').value,lightboxId:this._lightbox.id})},onSuccess:function(r){var json=r.responseText.evalJSON();if(json.status==="1"){this._templateData.addAnother=(new Element('input',{type:'submit',id:'lbSendAnother','class':'cta1',value:this._templateData.buttons.emailAnother})).getOuterHTML();this._templateData.pageAdded=this._templateData.sendAnother.replace('%s',$('lbEmailAddress').value);this._updateModal('addPageDone',this._templateData.containerId,translations.search.lightbox.email.sent.title);$('lbSendAnother').observe('click',function(){$('lbSendAnother').stopObserving();this.show();}.bind(this));}}.bind(this)});},_templateData:{containerId:'',title:'',emailAddress:translations.search.lightbox.email.label.address,emailMessage:translations.search.lightbox.email.label.message,sendAnother:translations.search.lightbox.email.sent.message,failure:{file:translations.search.lightbox.email.invalidAddress,message:''},buttons:{send:translations.search.lightbox.email.send,emailAnother:translations.search.lightbox.email.anotherFriend}},_lightbox:{}});namespacing.init('istock.search.lightbox');istock.search.lightbox.AddFiles=Class.create(istock.search.lightbox.Dialog,{show:function($super,action){var fnAdd='_'+action+'ToLightbox',isLightbox=(this._lightbox.id>0),modalContainer=$$('.modalDialog')[0],flags=(istock.search.lightbox&&istock.search.lightbox.flags)||{isOwner:false,isAdmin:false};this._templateData.buttons.add=this._templateData.buttons[action];this._templateData.action=action;if(action==='addPage'){this._updateModal('add','lbAddDialog',translations.search.lightbox.addPage.title);}else if(action==='addFiles'){if(isLightbox&&(flags.isOwner||flags.isAdmin)){this._updateModal('addByFileId','lbAddFileDialog',translations.search.lightbox.addFile.title);}else{this._updateModal('add','lbAddDialog',translations.search.lightbox.addFile.title);}}else{return;}
if(!modalContainer||!modalContainer.visible()){$super();}
if(action==='addPage'||(action==='addFiles'&&!(isLightbox&&(flags.isOwner||flags.isAdmin)))){this._getLightboxes();}
$('lbAdd').observe('click',function(){var lb=istock.search.lightbox.flags;if(this._validateAddFields()){if(isLightbox&&(lb.isOwner||lb.isAdmin)){this.clearFileIds();if(action==='addFiles'&&$('lbAddFileId')){this.addFileId($('lbAddFileId').value);}}
this[fnAdd]();}}.bind(this));},hide:function($super){if($('lbAdd')){$('lbAdd').stopObserving();}
$$('#'+this._templateData.containerId+' .modalClose')[0].stopObserving();$super();},toggleCreate:function(){var arrowImg=$$('.modalDialog img.toggleCreate')[0],form=$('lbCreate');Effect.toggle('lbCreate','slide',{duration:0.2,afterFinish:function(){arrowImg.toggleClassName('ctaGreyArrowDown');arrowImg.toggleClassName('ctaGreyArrowUp');}});},addFileId:function(fileId){if(isNaN((fileId=parseInt(fileId,10)))){return;}
this._filesToAdd.push(fileId);},clearFileIds:function(){this._filesToAdd=[];},_validateAddFields:function(){var errMsg='',errOpt={duration:0.5,afterFinish:function(){errMsg.remove();}},t=translations.search.lightbox.addFile.validation;if($('lbAddSelect')&&$('lbAddName')&&parseInt($('lbAddSelect').value,10)<0&&$('lbAddName').value===''){if(!$('lbCreate').visible()){errMsg=new Element('div',{'class':'err'}).update(t.mustSelect);$('lbAddSelect').insert({after:errMsg});setTimeout(function(){errMsg.fade(errOpt);},2000);}else{errMsg=new Element('div',{'class':'err'}).update(t.enterName);$('lbAddName').insert({after:errMsg});setTimeout(function(){errMsg.fade(errOpt);},2000);}
return false;}else if($('lbAddFileId')&&$('lbAddFileId').value===''){errMsg=new Element('div',{'class':'err'}).update(t.enterId);$('lbAddFileId').insert({after:errMsg});setTimeout(function(){errMsg.fade(errOpt);},2000);return false;}
return true;},_getSearchToken:function(){var token=istock.searchToken;if(token===null||typeof token==='undefined'){token=istock.search.resultsHandler.getSearchToken().substr(0,7);}
return token;},_createLightbox:function(){var lightbox={name:$('lbAddName').value,keywords:$('lbAddKeywords').value,description:$('lbAddDescription').value,searchToken:this._getSearchToken(),abstractFileIds:this._filesToAdd||[]};this._sendXHR('create',lightbox);},_addFilesToLightbox:function(){var files=[],selectEl=$('lbAddSelect'),value,text,ajx,i,lightbox;if(selectEl){value=parseInt(selectEl.value,10);text=selectEl.select('option:selected')[0].innerHTML;}else if(this._lightbox&&this._lightbox.id){value=this._lightbox.id;text=this._lightbox.name;}else{return false;}
lightbox={name:text,lightboxId:value,addAction:true,searchToken:this._getSearchToken(),abstractFileIds:this._filesToAdd||[]};if(($('lbCreate')&&$('lbCreate').visible())&&$('lbAddName').value!==''){this._createLightbox();}else if(this._filesToAdd.length>0){this._sendXHR('updateFiles',lightbox);}},_sendXHR:function(method,data){var ajx=new Ajax.Request('/my-account/lightbox/'+method,{method:'post',parameters:{options:Object.toJSON(data)},onSuccess:function(r){var response=r.responseText.evalJSON(),fullPage=false,id;if(method==='create'){id=response.id;}else{id=data.lightboxId;}
if(response.status==='1'&&response.filesUpdated>0){this._setLastLightbox(id);this._displaySuccessAdding(response.filesUpdated);if(data.abstractFileIds.length>1){fullPage=true;}
if(method==='create'){document.fire('omniture:lightboxCreate',{'name':data.name,'page':fullPage});}else{document.fire('omniture:lightboxAdd',{'name':data.name,'page':fullPage});}}else if((method==='updateFiles'&&response.status==='0')||response.status==='1'&&response.filesUpdated<=0){this._displayErrorAdding(id,data.name,'file');}else if(method==='create'&&response.status==='0'){this._displayErrorAdding(-1,data.name,'create');}}.bind(this),onFailure:function(){this._displayErrorAdding(data.lightboxId||-1,data.name,'file');}.bind(this)});},_displaySuccessAdding:function(filesUpdated){var lb=(istock.search.lightbox&&istock.search.lightbox.flags)||{isOwner:false,isAdmin:false};if(this._templateData.action==='addFiles'&&(lb.isOwner||lb.isAdmin)){this._templateData.addAnother=(new Element('input',{type:'submit',id:'lbAddAnother','class':'cta1',value:this._templateData.buttons.addAnother})).getOuterHTML();if(filesUpdated>0){istock.search.resultsHandler.adjustTotalResultCount(filesUpdated);}}else{setTimeout(function(){this.hide();}.bind(this),3000);}
this._updateModal('addPageDone',this._templateData.containerId,translations.search.lightbox.addFile.done);if(this._templateData.action==='addFiles'&&(lb.isOwner||lb.isAdmin)){$('lbAddAnother').observe('click',function(){$('lbAddAnother').stopObserving();this.show(this._templateData.action);}.bind(this));}},_displayErrorAdding:function(id,name,type){if(parseInt(id,10)===-1){this._templateData.failure.message=this._templateData.failure[type].replace('%s','/my-account/lightbox/').replace('%s',name);}else{this._templateData.failure.message=this._templateData.failure[type].replace('%s','/search/lightbox/'+id+'/').replace('%s',name);}
this._updateModal('actionFailed',this._templateData.containerId,translations.search.lightbox.addFile.failed);$('lbTryAgain').observe('click',function(){$('lbTryAgain').stopObserving();this.show(this._templateData.action);}.bind(this));},_addPageToLightbox:function(){var displayedOnly=true,files=istock.search.resultsHandler.getResultSet(displayedOnly),i;this.clearFileIds();for(i=0;i<files.length;i++){this.addFileId(files[i].id);}
this._addFilesToLightbox();},_populateLightboxes:function(){var i=0,option,select=$('lbAddSelect'),lightboxes=this._lightboxes,lastLightbox=this._getLastLightbox();if($('findingLightboxes')){$('findingLightboxes').remove();}
for(i=0;i<lightboxes.length;i++){if(this._lightbox.id===lightboxes[i].id){continue;}
option=new Element('option',{value:lightboxes[i].id});option.update(lightboxes[i].name);select.insert(option);if(parseInt(lastLightbox,10)===parseInt(lightboxes[i].id,10)){option.selected=true;}}},_getLightboxes:function(){var ajx,option,select;if(this._lightboxes.length>0){this._populateLightboxes();}else{select=$('lbAddSelect');option=new Element('option',{id:'findingLightboxes',value:'loading'});option.update(translations.search.lightbox.addFile.retrievingList);select.insert(option);ajx=new Ajax.Request('/json/getlightboxes',{method:'post',onSuccess:function(r){var json=r.responseText.evalJSON();if(json.status==="1"){this._lightboxes=json.lightboxes;this._populateLightboxes();}}.bind(this)});}},_setLastLightbox:function(id){if(istock.localStorage){istock.localStorage.setItem('lastLightbox',id);}},_getLastLightbox:function(){return istock.localStorage&&parseInt(istock.localStorage.getItem('lastLightbox'),10);},_templateData:{containerId:'',title:'',createLightbox:translations.search.lightbox.addFile.create,selectLightbox:translations.search.lightbox.addFile.select,pageAdded:translations.search.lightbox.addFile.filesAdded,failure:{file:translations.search.lightbox.addFile.unableToAdd,create:translations.search.lightbox.addFile.unableToAdd,message:''},form:{name:translations.search.lightbox.addFile.name,description:translations.search.lightbox.addFile.description,keywords:translations.search.lightbox.addFile.keywords,enterFileIds:translations.search.lightbox.addFile.enterIds},buttons:{add:'',addPage:translations.search.lightbox.addPage.button,addFiles:translations.search.lightbox.addFile.button,addAnother:translations.search.lightbox.addFile.addAnother,tryAgain:translations.search.lightbox.addFile.tryAgain}},_lightboxes:[],_filesToAdd:[]});namespacing.init('istock.search');istock.search.LightboxDialog=Class.create(istock.Modal,{hide:function($super){$$('#'+this._templateData.containerId+' .modalClose')[0].stopObserving();$super();},_showDialog:function(template,id,title){var content=istock.search.templates.lightbox[template];this._templateData.containerId=id;this._templateData.title=title;this._templateData.content=content.evaluate(this._templateData);this._modal.update(this._dialog.evaluate(this._templateData));this.show();$$('#'+this._templateData.containerId+' .modalClose')[0].observe('click',function(){this.hide();}.bind(this));},_templateData:{containerId:'',title:'',createLightbox:translations.search.lightbox.addFile.create,selectLightbox:translations.search.lightbox.addFile.select,form:{name:translations.search.lightbox.addFile.name,description:translations.search.lightbox.addFile.description,keywords:translations.search.lightbox.addFile.keywords,enterFileIds:translations.search.lightbox.addFile.enterIds},buttons:{addPage:translations.search.lightbox.addPage.button,addFile:translations.search.lightbox.addFile.button}},_dialog:istock.templates.lightbox.dialog});namespacing.init('istock.search');istock.search.resultsHandler={_resultData:null,_keyIsDown:false,_isNewPage:false,getTotalPages:function(){return(Math.ceil(this.getTotalResultCount()/this.getItemsPerPage()))||0;},getCurrentTimestamp:function(){return this._getData('timestamp')||false;},getCurrentPage:function(){return this._getData('page')||1;},getSearchToken:function(){return this._getData('searchToken')||'default';},getTotalResultCount:function(){return this._getData('totalResultCount')||0;},getIsHistoryLoad:function(){return this._getData('isHistoryLoad')||false;},getUserSegmentId:function(){return this._getData('segmentId')||'Default';},adjustTotalResultCount:function(num){if(!this._resultData){return;}
this._resultData.totalResultCount=this.getTotalResultCount()+num;istock.search.event.fire(istock.search.event.UPDATE_TITLE,{count:istock.search.resultsHandler.getTotalResultCount()});},getItemsPerPage:function(){var perPage=istock.search.preferences.get('perPage');if(perPage<20){return 50;}
return perPage;},getResultSet:function(displayOnly){var self=istock.search.resultsHandler,results;if((results=self._getData('results'))){results=results.clone();if(displayOnly){results=results.splice(0,self.getItemsPerPage());}
return results;}
return[];},getResultMeta:function(id){var self=istock.search.resultsHandler,results=self._resultData.results,i;for(i=0;i<results.length;i++){if(results[i].id===id){return results[i];}}
return false;},setResultMeta:function(id,key,value){var self=istock.search.resultsHandler,results=self._resultData.results,i;for(i=0;i<results.length;i++){if(results[i].id===id){results[i][key]=value;return results[i];}}
return false;},resizeContainer:function(size){$('srchCntr').setStyle({'height':size+'px'});},render:function(data){this._resultData=data;this.crear();if(('errorCode'in data&&data.errorCode!==0)||!'results'in data||data.results.size()<=0){this.renderZeroResults();return;}
if('audioOnly'in data&&data.audioOnly){this.renderListView();return;}
this.renderThumbnails();},renderThumbnails:function(){var arrResults,result,resultItem,html='',item;if(!(arrResults=this.getResultSet()).size()){return false;}
for(item=0;item<this.getItemsPerPage();item++){result=arrResults[item];if(!result){continue;}
html+=(new istock.search.results.Item(result)).toHTML();}
this._updateSearchResults(html);this.updateLastRow();(function(){if(!Prototype.Browser.IE||Prototype.Browser.Version[0]>=8){istock.search.results.Item.loadImages(arrResults);}}).defer();},renderListView:function(){var resultsContainer=istock.search.templates.audio.container,details={heading:{title:translations.search.audioList.title,genre:translations.search.audioList.genre,contributor:translations.search.audioList.contributor,tempo:translations.search.audioList.tempo,key:translations.search.audioList.key,duration:translations.search.audioList.duration,downloads:translations.search.audioList.downloads},rows:''};this.getResultSet(true).each(function(result){details.rows+=(new istock.search.results.Row(result)).toHTML();});this._updateSearchResults(resultsContainer.evaluate(details));},renderZeroResults:function(){$('srchRslts').insert((new istock.search.ZeroResults(this._getData('errorCode'))).render());if($('lightboxTools')){$('lightboxTools').hide();}
istock.search.GettyLinks.hide();istock.search.paginator.hide();this._resultData=null;},updateLastRow:function(){this._addNext();this._addLastRowClass();this._addClearDiv();},crear:function(){istock.widget.Loupe.hideAll();$('srchRslts').update('');},_updateSearchResults:function(html){$('srchRslts').insert(html);if($('lightboxTools')){$('lightboxTools').show();}
istock.search.paginator.render();istock.search.GettyLinks.show();document.fire(istock.search.event.RESULTS_RENDERED);},_getData:function(prop){if(!this._resultData||!prop in this._resultData){return null;}
return this._resultData[prop];},_addNext:function(){var resultItem;$$('.srItem.preview').invoke('remove');if(this.getCurrentPage()!==this.getTotalPages()&&!this._getData('audioOnly')&&this.getResultSet().size())
{resultItem=istock.search.templates.nextResultSetButton.evaluate({eventClass:'e_page',page:this.getCurrentPage()+1});$('srchRslts').insert(resultItem);}},_addClearDiv:function(){var results=$('srchRslts'),clear=new Element('div',{'class':'clear'});results.select('> div.clear').invoke('remove');results.insert({bottom:clear});},_getItemsPerRow:function(){var container=$('srchRslts'),dim={innerWidth:0,itemWidth:0},searchResult=$$('.srItem:not(.preview)')[0];if(!searchResult){return;}
dim.innerWidth=container.getLayout().get('padding-box-width');dim.itemWidth=searchResult.getLayout().get('margin-box-width');return Math.floor(dim.innerWidth/dim.itemWidth);},_addLastRowClass:function(){var self=istock.search.resultsHandler,itemsPerRow=self._getItemsPerRow(),items=$$('.srItem'),numItemsOnLastRow=items.length%itemsPerRow,i;items.invoke('removeClassName','lastRow');numItemsOnLastRow=numItemsOnLastRow===0?itemsPerRow:numItemsOnLastRow;for(i=items.length-1;i>items.length-numItemsOnLastRow-1;i--){if(!items[i]){continue;}
items[i].addClassName('lastRow');}},observe:function(e){var classes=$w(e.element().className),self=istock.search.resultsHandler,p,index=0;if(e.type==='keydown'&&(e.keyCode===Event.KEY_LEFT||e.keyCode===Event.KEY_RIGHT)&&(e.element().type!=='text')&&!(self._keyIsDown)){p=self.getCurrentPage();if(e.keyCode===Event.KEY_LEFT){p--;}else{p++;}
classes=['e_page','pg'+p];self._keyIsDown=true;}
if(e.type==='keyup'&&self._keyIsDown){self._keyIsDown=false;}
if(classes[0]&&(classes[0].startsWith('e_')||(index=classes.indexOf('e_loupe')))){self.cls=classes[index];switch(self.cls){case'e_loupe':if(e.type!=='mouseover'&&e.type!=='mouseout'){return;}
(function(){var id=parseInt(e.element().identify().replace('thumbnail_',''),10),item,result,loupe;if(e.type==='mouseover'){for(item=0;item<self._resultData.results.length;item++){result=self._resultData.results[item];if(result.id===id){loupe=new istock.widget.Loupe(result);loupe.show();}}}else if(e.type==='mouseout'){istock.widget.Loupe.hide(id);}})();break;case'e_page':(function(e){var page;if((e.type==='click'||e.type==='keydown')&&e.element().type!=='text'){page=parseInt(classes[1].replace('pg',''),10);}else if(e.type==='keypress'&&e.element().type==='text'&&e.keyCode===Event.KEY_RETURN){page=parseInt(e.element().value,10);if(isNaN(page)){e.stop();return;}}else if(e.type==='keypress'&&e.element().type==='text'&&((e.charCode<48||e.charCode>57)&&e.keyCode!==Event.KEY_BACKSPACE&&e.keyCode!==Event.KEY_DELETE&&e.keyCode!==Event.KEY_LEFT&&(e.keyCode!==Event.KEY_RIGHT))){e.stop();return false;}else{return;}
e.stop();if(!self.getResultSet().size()){return;}
if(page<1){page=1;}else if(page>self.getTotalPages()){page=self.getTotalPages();}
if(page===self.getCurrentPage()){e.stop();return;}
istock.search.event.fire(istock.search.event.NEW_PAGE,new istock.search.Facet(istock.search.facetTypes.PAGE_NUMBER,page,'Page Number'));self._isNewPage=true;})(e);break;case'e_filesPerPage':if(e.type!=='change'){return;}
(function(e){var filesPerPage,list;list=e.element();filesPerPage=parseInt(list.value,10);if(self.lastPerPage&&self.lastPerPage===filesPerPage){return;}
self.lastPerPage=filesPerPage;$$('.e_filesPerPage').each(function(fpp){if(parseInt(fpp.value,10)!==filesPerPage){fpp.select('option[value="'+filesPerPage+'"]')[0].selected=true;}});istock.search.preferences.set('perPage',filesPerPage);istock.search.event.fire(istock.search.event.ADD_FACET,new istock.search.Facet(istock.search.facetTypes.PER_PAGE,filesPerPage,'Files per page'));})(e);break;case'e_sortBy':if(e.type!=='change'){return;}
(function(){var sortBy,list;list=e.element();sortBy=parseInt(list.value,10);istock.search.preferences.set('order',sortBy);istock.search.event.fire(istock.search.event.ADD_FACET,new istock.search.Facet(istock.search.facetTypes.RESULT_ORDER,sortBy,list.select('option[value="'+sortBy+'"]')[0].innerHTML));})();break;case'e_dispSetting':if(e.type!=='click'){return;}
if(classes[1]==='srAlwaysExcludeEditorial'){istock.search.displaySettings.setAlwaysExcludeEditorial(classes[1],e.element().checked);}else{istock.search.displaySettings.setMeta(classes[1],e.element().checked);}
document.fire(istock.search.event.RESULTS_RENDERED);break;case'e_listPlayer':if(e.type!=='click'){return;}
(function(classes){var action=classes[2],toggle=parseInt(classes[3],10),id=parseInt(classes[4],10);if(action==='playAudio'){istock.search.listPlayers.play(id,toggle);}else{istock.search.listPlayers.pause(id,toggle);}})(classes);break;default:break;}}}};Event.observe(document,'search:loaded',function(){var rH=istock.search.resultsHandler,timeoutId;Event.observe(document,'click',rH.observe);Event.observe(document,'mouseover',rH.observe);Event.observe(document,'mouseout',rH.observe);Event.observe(document,'keypress',rH.observe);Event.observe(document,'keydown',rH.observe);Event.observe(document,'keyup',rH.observe);Event.observe(document,istock.search.event.NEW_RESULTS,function(event){var rH=istock.search.resultsHandler,data=event.memo;if(!$$('nav')[0].isInViewport()&&rH._isNewPage){$$('header')[0].scrollTo();rH._isNewPage=false;}
rH.crear();rH.render(data);if(istock.loggedin){istock.search.email.OptInLink.show();}else{istock.search.email.OptInLink.hide();}});Event.observe(window,'resize',function(){if(timeoutId){clearTimeout(timeoutId);timeoutId=null;}
if(rH.getResultSet().size()){timeoutId=setTimeout(rH.updateLastRow.bind(rH),100);}});});Event.observe(window,'unload',function(){istock.widget.Loupe.hideAll();});namespacing.init('istock.search.event');istock.search.event.namespace='facetedSearch:';istock.search.event={ADD_FACET:istock.search.event.namespace+'add_facet',REMOVE_FACET:istock.search.event.namespace+'remove_facet',UPDATE_FACET:istock.search.event.namespace+'update_facet',NEW_RESULTS:istock.search.event.namespace+'resultsUpdated',NEW_PAGE:istock.search.event.namespace+'new_page',QUERY_BUILDER_REDRAW:istock.search.event.namespace+'query_builder_redraw',DISAMBIG_DETECTED:istock.search.event.namespace+'disamgibuation_detected',DISAMBIG_REQUESTED:istock.search.event.namespace+'disamgibuation_requested',SPELLING_DETECTED:istock.search.event.namespace+'spelling_detected',SPELLING_REQUESTED:istock.search.event.namespace+'spelling_requested',RESULT_SET_UPDATED:istock.search.event.namespace+'result_set_updated',SEARCH_ERROR:istock.search.event.namespace+'search_error',UPDATE_TITLE:istock.search.event.namespace+'update_title',TOGGLE_FILTER:istock.search.event.namespace+'toggle_filter',RESULTS_RENDERED:istock.search.event.namespace+'results_rendered',ZERO_RESULTS:istock.search.event.namespace+'zero_results',fire:function(action,memo,arg){document.fire(action,this._createMemo(action,memo,arg));},_createMemo:function(action,memo,arg){switch(action){case this.ADD_FACET:case this.REMOVE_FACET:case this.NEW_PAGE:return{'facet':memo,'isRenderOnly':((arg!==undefined)?arg:false)};case this.UPDATE_FACET:return{'oldFacet':memo,'newFacet':arg};case this.DISAMBIG_REQUESTED:case this.SPELLING_REQUESTED:return{'title':arg,'container':memo};default:return memo;}}};document.fire("lightboxadd:loaded");});